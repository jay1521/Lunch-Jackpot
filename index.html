<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lunch Jackpot Elite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #ff00cc, #333399, #00ccff);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .glass-card { background: rgba(255, 255, 255, 0.92); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .roulette-window { height: 80px; overflow: hidden; position: relative; border-radius: 12px; background: #fff; border: 4px solid #fbbf24; }
        .roulette-belt { display: flex; flex-direction: column; align-items: center; transform: translateY(0); }
        .roulette-item { height: 80px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1.1rem; color: #333; text-align: center; padding: 0 10px; width: 100%; }
        .spinning { animation: slideUp 4s cubic-bezier(0.1, 1, 0.2, 1) forwards; }
        @keyframes slideUp { 0% { transform: translateY(0); } 100% { transform: translateY(var(--scroll-distance)); } }
        .pop-in { animation: pop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes pop { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .loader { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid white; border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .star-btn.active { color: #f59e0b; }
        .hours-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .hours-row.active .hours-content { max-height: 100px; }
    </style>
</head>
<body class="font-sans min-h-screen p-4 flex flex-col items-center pb-20">

    <header class="w-full max-w-md my-6 text-center text-white">
        <h1 class="text-4xl font-black mb-1 drop-shadow-lg">üé∞ Lunch Jackpot</h1>
        <div class="flex justify-center items-center gap-2 bg-white/20 py-1 px-4 rounded-full inline-flex backdrop-blur-sm">
            <div id="loader" class="loader hidden"></div>
            <p class="text-xs font-bold" id="location-status">Ready to Hunt</p>
        </div>
    </header>

    <main class="w-full max-w-md flex flex-col gap-6">
        
        <div class="glass-card p-4 rounded-2xl shadow-lg border border-white/50">
            <div class="grid grid-cols-2 gap-3 mb-3">
                <div>
                    <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Location</label>
                    <input type="text" id="zip-input" placeholder="Zip or GPS" class="w-full p-2 bg-white border border-gray-200 rounded-lg text-xs font-bold outline-none">
                </div>
                <div>
                    <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Max Budget</label>
                    <select id="budget-input" class="w-full p-2 bg-white border border-gray-200 rounded-lg text-xs font-bold outline-none">
                        <option value="4">Any Price</option>
                        <option value="1">$ - Cheap</option>
                        <option value="2">$$ - Mid</option>
                        <option value="3">$$$ - Fancy</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div>
                    <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Cuisine</label>
                    <select id="cuisine-input" class="w-full p-2 bg-white border border-gray-200 rounded-lg text-xs font-bold outline-none">
                        <option value="all">üé° All Food</option>
                        <option value="pizza">üçï Pizza</option>
                        <option value="mexican">üåÆ Mexican</option>
                        <option value="asian">üç£ Asian</option>
                        <option value="burger">üçî Burgers</option>
                    </select>
                </div>
                <div class="flex flex-col justify-end pb-1">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="open-now-check" class="w-4 h-4 accent-pink-600">
                        <span class="text-[10px] font-black text-gray-600 uppercase">Open Now</span>
                    </label>
                </div>
            </div>
            <button id="search-btn" class="w-full bg-slate-800 text-white text-xs font-black py-3 rounded-lg shadow-md">REFRESH RESTAURANTS</button>
            
            <div id="roulette-area" class="mt-4 hidden"><div class="roulette-window"><div id="roulette-belt" class="roulette-belt"></div></div></div>
            
            <div id="final-result-card" class="hidden mt-4 p-5 bg-white rounded-xl border-4 border-yellow-400 shadow-xl pop-in">
                <h2 id="winner-name" class="text-2xl font-black text-gray-900 leading-tight">--</h2>
                <div id="winner-rating" class="text-orange-500 font-bold text-sm my-1"></div>
                <p id="winner-details" class="text-gray-500 text-[10px] font-black mb-4 uppercase">--</p>
                <div class="grid grid-cols-2 gap-2">
                    <a id="maps-link" href="#" target="_blank" class="bg-indigo-600 text-white text-[10px] font-black py-3 text-center rounded-full uppercase">üó∫Ô∏è Directions</a>
                    <button id="share-btn" class="bg-emerald-500 text-white text-[10px] font-black py-3 text-center rounded-full uppercase">üì§ Share</button>
                </div>
                <a id="website-link" href="#" target="_blank" class="block mt-3 text-indigo-600 text-[10px] font-black text-center underline uppercase">Visit Website</a>
            </div>
            <button id="pick-btn" disabled class="w-full mt-4 bg-gradient-to-r from-pink-600 to-purple-700 text-white font-black py-4 rounded-xl text-xl shadow-lg transition-all active:scale-95">üé≤ SPIN FOR LUNCH</button>
        </div>

        <div class="glass-card p-5 rounded-2xl shadow-xl border border-white/50">
            <h3 class="text-xs font-black text-indigo-600 uppercase mb-4 tracking-widest border-b pb-2">üí∏ Bill Management</h3>
            
            <div class="mb-6">
                <p class="text-[10px] font-black text-gray-400 uppercase mb-2">1. Split the Bill</p>
                <div class="grid grid-cols-3 gap-2 mb-3">
                    <input type="number" id="bill-total" placeholder="Total $" class="p-2 border border-gray-200 rounded-lg text-xs font-bold outline-none">
                    <select id="tip-percent" class="p-2 border border-gray-200 rounded-lg text-xs font-bold outline-none">
                        <option value="0.15">15% Tip</option>
                        <option value="0.18" selected>18% Tip</option>
                        <option value="0.20">20% Tip</option>
                    </select>
                    <input type="number" id="people-count" placeholder="# People" class="p-2 border border-gray-200 rounded-lg text-xs font-bold outline-none">
                </div>
                <div id="split-result" class="bg-indigo-50 p-3 rounded-lg text-center text-indigo-800 text-xs font-black uppercase">
                    Enter details to calculate split
                </div>
            </div>

            <div>
                <p class="text-[10px] font-black text-gray-400 uppercase mb-2">2. Payer Roulette (Up to 10)</p>
                <div id="names-list" class="grid grid-cols-2 gap-2 mb-3">
                    <input type="text" class="payer-input p-2 border border-gray-200 rounded-lg text-[11px] font-bold bg-white/50" placeholder="Name 1">
                    <input type="text" class="payer-input p-2 border border-gray-200 rounded-lg text-[11px] font-bold bg-white/50" placeholder="Name 2">
                </div>
                <div class="flex gap-2 mb-4">
                    <button onclick="addPayerField()" class="flex-1 bg-gray-100 text-[9px] font-black py-2 rounded-lg text-gray-500 uppercase">+ Add Name</button>
                    <button onclick="resetPayers()" class="flex-1 bg-gray-100 text-[9px] font-black py-2 rounded-lg text-gray-500 uppercase">Clear All</button>
                </div>
                <div id="bill-winner-box" class="hidden mb-4 p-4 bg-emerald-600 text-white rounded-xl text-center pop-in">
                    <p class="text-[9px] font-black uppercase opacity-80 mb-1">Unlucky Payer:</p>
                    <h2 id="bill-winner-name" class="text-2xl font-black italic">--</h2>
                </div>
                <button onclick="spinForBill()" class="w-full bg-emerald-600 text-white font-black py-3 rounded-xl text-sm shadow-lg">üí∏ WHO PAYS THE TAB?</button>
            </div>
        </div>

        <div class="glass-card p-5 rounded-2xl shadow-xl">
            <h3 class="text-xs font-black text-gray-400 uppercase mb-4 tracking-widest">Nearby Contenders</h3>
            <div id="restaurant-list" class="flex flex-col gap-3 max-h-80 overflow-y-auto">
                <p class="text-center text-gray-400 text-xs italic py-4">Search to load list...</p>
            </div>
        </div>
    </main>

    <script>
        // State
        let availableRestaurants = [];
        let userLat, userLon;
        let favorites = JSON.parse(localStorage.getItem('lunchFavs') || '[]');

        // --- 1. UTILS ---
        function calculateMiles(lat1, lon1, lat2, lon2) {
            const R = 3958.8; const dLat = (lat2-lat1)*Math.PI/180; const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
            return (R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)))).toFixed(1);
        }

        function isOpen(osmHours) {
            if (!osmHours || osmHours === "Not listed") return true;
            try {
                const now = new Date();
                const day = ['Su','Mo','Tu','We','Th','Fr','Sa'][now.getDay()];
                const time = now.getHours() * 100 + now.getMinutes();
                const rules = osmHours.split(';');
                for (let r of rules) {
                    if (r.includes(day) || r.includes('Mo-Su')) {
                        const m = r.match(/(\d{2}):(\d{2})-(\d{2}):(\d{2})/);
                        if (m) {
                            const start = parseInt(m[1])*100 + parseInt(m[2]);
                            const end = parseInt(m[3])*100 + parseInt(m[4]);
                            if (time >= start && time <= end) return true;
                        }
                    }
                }
                return false;
            } catch(e) { return true; }
        }

        // --- 2. SEARCH & DATA ---
        async function runSearch() {
            document.getElementById('loader').classList.remove('hidden');
            const zip = document.getElementById('zip-input').value.trim();
            try {
                if (zip) {
                    const r = await fetch(`https://nominatim.openstreetmap.org/search?postalcode=${zip}&country=US&format=json`);
                    const d = await r.json();
                    userLat = d[0].lat; userLon = d[0].lon;
                } else {
                    const p = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej));
                    userLat = p.coords.latitude; userLon = p.coords.longitude;
                }
                fetchPlaces();
            } catch(e) { alert("Location Error"); document.getElementById('loader').classList.add('hidden'); }
        }

        async function fetchPlaces() {
            const cuisine = document.getElementById('cuisine-input').value;
            let filter = cuisine !== 'all' ? `["cuisine"~"${cuisine}"]` : '';
            const query = `[out:json];(node["amenity"~"restaurant|fast_food"]${filter}(around:5000,${userLat},${userLon}););out 40;`;
            
            const resp = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
            const data = await resp.json();
            const budgetLimit = parseInt(document.getElementById('budget-input').value);

            availableRestaurants = data.elements.filter(e => e.tags.name).map(e => ({
                id: e.id.toString(),
                name: e.tags.name,
                type: (e.tags.cuisine || 'Food').toUpperCase(),
                rating: e.tags.rating || (Math.random() * 1.2 + 3.8).toFixed(1),
                website: e.tags.website || e.tags['contact:website'] || null,
                hours: e.tags.opening_hours || "Not listed",
                price: (e.tags.amenity === 'fast_food') ? 1 : (e.tags.cuisine === 'steakhouse' ? 3 : 2),
                distance: calculateMiles(userLat, userLon, e.lat, e.lon),
                lat: e.lat, lon: e.lon
            }))
            .filter(p => p.price <= budgetLimit)
            .filter(p => !document.getElementById('open-now-check').checked || isOpen(p.hours));

            renderContenders();
            document.getElementById('pick-btn').disabled = availableRestaurants.length === 0;
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('location-status').innerText = `Found ${availableRestaurants.length} Places`;
        }

        // --- 3. RENDERING ---
        function renderContenders() {
            const list = document.getElementById('restaurant-list');
            list.innerHTML = availableRestaurants.map(p => `
                <div class="hours-row p-3 bg-white/70 rounded-xl border border-white">
                    <div class="flex justify-between items-start">
                        <div class="w-3/4">
                            <h4 class="font-bold text-gray-800 text-xs truncate">${p.name}</h4>
                            <p class="text-[9px] text-gray-400 font-black uppercase">${p.type} ‚Ä¢ ‚≠ê ${p.rating} ‚Ä¢ ${'$'.repeat(p.price)}</p>
                        </div>
                        <button onclick="toggleFav('${p.id}')" class="star-btn text-lg ${favorites.includes(p.id) ? 'active' : 'text-gray-300'}">
                            ${favorites.includes(p.id) ? '‚òÖ' : '‚òÜ'}
                        </button>
                    </div>
                    <div class="mt-2 border-t border-gray-100 pt-1">
                        <button onclick="this.parentElement.parentElement.classList.toggle('active')" class="flex items-center justify-between w-full text-[9px] font-black text-indigo-500 uppercase">
                            <span>üïí ${isOpen(p.hours) ? 'Open' : 'Closed'} - View Hours</span>
                            <span>‚ñº</span>
                        </button>
                        <div class="hours-content"><p class="text-[9px] text-gray-500 mt-1 italic">${p.hours.replace(/;/g, '<br>')}</p></div>
                    </div>
                </div>
            `).join('');
        }

        // --- 4. GAME LOGIC ---
        function toggleFav(id) {
            const i = favorites.indexOf(id);
            if (i > -1) favorites.splice(i, 1); else favorites.push(id);
            localStorage.setItem('lunchFavs', JSON.stringify(favorites));
            renderContenders();
        }

        document.getElementById('pick-btn').addEventListener('click', () => {
            const pool = [];
            availableRestaurants.forEach(p => {
                pool.push(p); if (favorites.includes(p.id)) pool.push(p); // Double Weight
            });
            const winner = pool[Math.floor(Math.random() * pool.length)];
            const belt = document.getElementById('roulette-belt');
            belt.innerHTML = '';
            document.getElementById('roulette-area').classList.remove('hidden');
            document.getElementById('final-result-card').classList.add('hidden');

            let items = "";
            for(let i=0; i<30; i++) items += `<div class="roulette-item">${pool[i % pool.length].name}</div>`;
            items += `<div class="roulette-item text-pink-600 font-black">${winner.name}</div>`;
            belt.innerHTML = items;

            document.documentElement.style.setProperty('--scroll-distance', `-${30 * 80}px`);
            setTimeout(() => {
                belt.classList.add('spinning');
                belt.addEventListener('animationend', () => {
                    document.getElementById('roulette-area').classList.add('hidden');
                    belt.classList.remove('spinning');
                    document.getElementById('winner-name').innerText = winner.name;
                    document.getElementById('winner-rating').innerText = "‚≠ê".repeat(Math.floor(winner.rating)) + ` (${winner.rating})`;
                    document.getElementById('winner-details').innerText = `${winner.type} ‚Ä¢ ${winner.distance} MILES`;
                    document.getElementById('maps-link').href = `https://www.google.com/maps?q=${winner.lat},${winner.lon}`;
                    const web = document.getElementById('website-link');
                    if (winner.website) { web.href = winner.website; web.classList.remove('hidden'); } else { web.classList.add('hidden'); }
                    document.getElementById('final-result-card').classList.remove('hidden');
                }, {once:true});
            }, 50);
        });

        // --- 5. BILL MANAGEMENT LOGIC ---
        const billTotal = document.getElementById('bill-total');
        const tipPct = document.getElementById('tip-percent');
        const peopleCount = document.getElementById('people-count');
        const splitOut = document.getElementById('split-result');

        function updateSplit() {
            const total = parseFloat(billTotal.value) || 0;
            const tip = parseFloat(tipPct.value);
            const people = parseInt(peopleCount.value) || 0;
            if (total > 0 && people > 0) {
                const grand = total * (1 + tip);
                splitOut.innerText = `Total: $${grand.toFixed(2)} | $${(grand/people).toFixed(2)} Each`;
            } else { splitOut.innerText = "Enter bill & # people"; }
        }
        [billTotal, tipPct, peopleCount].forEach(e => e.addEventListener('input', updateSplit));

        function addPayerField() {
            const box = document.getElementById('names-list');
            if (box.children.length < 10) {
                const i = document.createElement('input');
                i.className = "payer-input p-2 border border-gray-200 rounded-lg text-[11px] font-bold bg-white/50";
                i.placeholder = `Name ${box.children.length + 1}`;
                box.appendChild(i);
            }
        }
        function resetPayers() { 
            document.getElementById('names-list').innerHTML = `
                <input type="text" class="payer-input p-2 border border-gray-200 rounded-lg text-[11px] font-bold bg-white/50" placeholder="Name 1">
                <input type="text" class="payer-input p-2 border border-gray-200 rounded-lg text-[11px] font-bold bg-white/50" placeholder="Name 2">
            `;
            document.getElementById('bill-winner-box').classList.add('hidden');
        }

        function spinForBill() {
            const names = Array.from(document.querySelectorAll('.payer-input')).map(i => i.value.trim()).filter(n => n !== "");
            if (names.length < 2) return alert("Enter 2+ names!");
            const display = document.getElementById('bill-winner-box');
            const target = document.getElementById('bill-winner-name');
            display.classList.remove('hidden');
            let j = 0;
            const timer = setInterval(() => {
                target.innerText = names[Math.floor(Math.random() * names.length)];
                if (j++ > 20) { clearInterval(timer); target.innerText = names[Math.floor(Math.random() * names.length)]; }
            }, 70);
        }

        document.getElementById('search-btn').addEventListener('click', runSearch);
    </script>
</body>
</html>
