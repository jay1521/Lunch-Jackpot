<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bite Roulette</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Titan+One&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-cream: #FFF8E1;
            --accent-orange: #FF8A65;
            --accent-red: #FF5252;
            --accent-blue: #4FC3F7;
            --accent-green: #81C784;
            --accent-purple: #BA68C8;
            --border-color: #1a1a1a;
        }

        body {
            background-color: var(--bg-cream);
            background-image: radial-gradient(#FFE0B2 2px, transparent 2px);
            background-size: 20px 20px;
            font-family: 'Nunito', sans-serif;
            color: var(--border-color);
        }

        h1, h2, h3, .tab-btn { font-family: 'Titan One', cursive; letter-spacing: 1px; }

        .cartoon-card {
            background: white;
            border: 3px solid var(--border-color);
            border-radius: 16px;
            box-shadow: 6px 6px 0px 0px rgba(0,0,0,0.8);
            margin-bottom: 16px;
        }
        
        input, select {
            border: 2px solid var(--border-color) !important;
            background: #fff !important;
            border-radius: 12px !important;
            font-weight: 800 !important;
            box-shadow: 2px 2px 0px 0px rgba(0,0,0,0.2);
        }
        
        button { font-family: 'Titan One', cursive; }
        
        .tab-btn { color: #555; border: 2px solid transparent; }
        .tab-btn.active {
            background: var(--accent-blue);
            color: white;
            border: 3px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 3px 3px 0px 0px #000;
            transform: translateY(-2px);
        }
        #tab-bar.active { background: var(--accent-purple); }

        .roulette-window { 
            height: 100px; overflow: hidden; position: relative; 
            border-radius: 16px; background: #fff; 
            border: 4px solid var(--border-color);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }
        .roulette-window::after {
            content: "‚ñº"; position: absolute; top: -5px; left: 50%; transform: translateX(-50%);
            color: var(--accent-red); font-size: 24px; z-index: 10; text-shadow: 2px 2px 0 #000;
        }

        .roulette-belt { display: flex; flex-direction: column; align-items: center; transform: translateY(0); }
        .roulette-item { 
            height: 100px; display: flex; align-items: center; justify-content: center; 
            font-family: 'Titan One', cursive; font-size: 1.4rem; color: #333; 
            text-align: center; padding: 0 10px; width: 100%; background-color: #fff;
        }
        .roulette-item:nth-child(odd) { background-color: #E1F5FE; }
        .roulette-item:nth-child(even) { background-color: #FFF3E0; }

        /* --- UPDATED SPIN DURATION TO 6s --- */
        .spinning { animation: slideUp 6s cubic-bezier(0.1, 1, 0.2, 1) forwards; }
        @keyframes slideUp { 0% { transform: translateY(0); } 100% { transform: translateY(var(--scroll-distance)); } }
        
        .user-location-dot { width: 16px; height: 16px; background-color: var(--accent-blue); border: 3px solid white; border-radius: 50%; box-shadow: 0 0 0 2px black; position: relative; }
        #map-container { height: 400px; width: 100%; border-radius: 12px; border: 3px solid var(--border-color); overflow: hidden; }
        
        .hours-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .hours-row.active .hours-content { max-height: 120px; overflow-y: auto; }
        .cartoon-title { color: var(--accent-orange); -webkit-text-stroke: 1.5px black; text-shadow: 3px 3px 0px #000; }
    </style>
</head>
<body class="min-h-screen pb-40">

    <header class="w-full max-w-md mx-auto p-6 text-center">
        <h1 class="text-4xl cartoon-title mb-2">BITE<br>ROULETTE</h1>
        <div class="inline-block bg-white border-2 border-black rounded-full px-4 py-1 shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]">
            <div class="flex items-center gap-2">
                <div id="loader" class="loader hidden w-3 h-3 border-2 border-black border-t-transparent rounded-full animate-spin"></div>
                <span id="location-status" class="text-[10px] font-black uppercase text-black">Ready to Spin</span>
            </div>
        </div>
    </header>

    <nav class="fixed bottom-4 left-1/2 -translate-x-1/2 w-[95%] max-w-md bg-white border-4 border-black rounded-2xl p-2 z-[1000] shadow-[6px_6px_0px_0px_rgba(0,0,0,1)]">
        <div class="flex flex-wrap justify-center gap-1">
            <button onclick="switchTab('jackpot')" id="tab-jackpot" class="tab-btn active flex-grow w-[30%] py-2 text-[8px] font-black uppercase">üçî Dine & Dice</button>
            <button onclick="switchTab('bar')" id="tab-bar" class="tab-btn flex-grow w-[30%] py-2 text-[8px] font-black uppercase">üç∏ 21+ (Bets Off)</button>
            <button onclick="switchTab('map')" id="tab-map" class="tab-btn flex-grow w-[30%] py-2 text-[8px] font-black uppercase">üó∫Ô∏è Map</button>
            
            <button onclick="switchTab('bill')" id="tab-bill" class="tab-btn flex-grow w-[45%] py-2 text-[8px] font-black uppercase">üí∏ Tab Roulette</button>
            <button onclick="switchTab('history')" id="tab-history" class="tab-btn flex-grow w-[45%] py-2 text-[8px] font-black uppercase">üìú Chicken Dinner</button>
        </div>
    </nav>

    <main class="w-full max-w-md mx-auto px-4">
        
        <div id="view-jackpot" class="tab-view flex flex-col gap-4">
            <div class="cartoon-card p-4">
                <h3 class="text-xs font-black uppercase mb-2 text-center text-blue-400">üçî Dine & Dice</h3>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <input type="text" id="food-zip" placeholder="Zip Code" class="p-2 w-full text-sm">
                    <select id="food-dist" class="p-2 w-full text-sm">
                        <option value="1609">1 Mile</option>
                        <option value="4828" selected>3 Miles</option>
                        <option value="8046">5 Miles</option>
                        <option value="16093">10 Miles</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <select id="food-cuisine" class="p-2 w-full text-sm">
                        <option value="restaurant">üé° All Food</option>
                        <option value="pizza">üçï Pizza</option>
                        <option value="mexican">üåÆ Mexican</option>
                        <option value="burger">üçî Burger</option>
                        <option value="sushi">üç£ Sushi</option>
                        <option value="thai">üçú Thai</option>
                    </select>
                    <select id="food-budget" class="p-2 w-full text-sm">
                        <option value="4">Any Price</option>
                        <option value="1">$ Cheap</option>
                        <option value="2">$$ Mid</option>
                    </select>
                </div>
                <div class="flex justify-center mb-3">
                    <label class="flex items-center gap-2 justify-center bg-gray-100 border-2 border-black px-4 py-2 rounded-lg cursor-pointer w-full">
                        <input type="checkbox" id="food-open" class="w-5 h-5 accent-blue-500 rounded border-2 border-black">
                        <span class="text-xs font-black uppercase">Open Now Only</span>
                    </label>
                </div>
                <button onclick="runSearch('food')" class="w-full py-3 text-sm tracking-wider bg-blue-400 text-white border-3 border-black rounded-full shadow-[4px_4px_0_black] uppercase">Update List</button>
            </div>

            <div id="roulette-food" class="hidden my-4"><div class="roulette-window"><div id="belt-food" class="roulette-belt"></div></div></div>
            
            <div id="result-food" class="hidden cartoon-card p-4 text-center border-yellow-400 bg-yellow-50">
                <p class="text-[10px] font-black text-yellow-600 uppercase tracking-widest mb-1">üéâ WINNER WINNER üéâ</p>
                <h2 id="name-food" class="text-2xl font-black text-gray-900 leading-none mb-2 mt-2" style="font-family: 'Titan One';">--</h2>
                <div id="rating-food" class="text-orange-500 font-bold text-sm mb-2"></div>
                <p id="details-food" class="text-gray-600 text-xs font-black mb-4 uppercase tracking-widest">--</p>
                <a id="menu-food" href="#" target="_blank" class="block w-full bg-orange-400 text-white font-black py-3 rounded-xl border-2 border-black shadow-[3px_3px_0_black] mb-3 flex items-center justify-center gap-2 active:translate-y-1 active:shadow-none transition-all"><span>üìñ VIEW MENU</span></a>
                <div class="grid grid-cols-2 gap-3">
                    <a id="maps-food" href="#" target="_blank" class="bg-blue-500 text-white text-xs font-black py-3 rounded-xl border-2 border-black shadow-[3px_3px_0_black] active:translate-y-1 active:shadow-none transition-all uppercase block">üó∫Ô∏è Go There</a>
                    <button id="share-food" class="bg-green-500 text-white text-xs font-black py-3 rounded-xl border-2 border-black shadow-[3px_3px_0_black] active:translate-y-1 active:shadow-none transition-all uppercase">üì§ Share</button>
                </div>
            </div>

            <button id="spin-food" disabled class="w-full py-5 text-xl tracking-widest mb-4 bg-red-500 text-white border-3 border-black rounded-full shadow-[4px_4px_0_black] font-black uppercase">ROLL THE DICE!</button>

            <div class="cartoon-card p-4">
                <h3 class="text-xs font-black uppercase mb-3 text-gray-400">üëá Candidates</h3>
                <div id="list-food" class="flex flex-col gap-3 max-h-60 overflow-y-auto pr-1"></div>
            </div>
        </div>

        <div id="view-bar" class="tab-view hidden flex flex-col gap-4">
            <div class="cartoon-card p-4 border-purple-900">
                <h3 class="text-xs font-black uppercase mb-2 text-center text-purple-600">üç∏ All Bets Are Off (21+)</h3>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <input type="text" id="bar-zip" placeholder="Zip Code" class="p-2 w-full text-sm">
                    <select id="bar-dist" class="p-2 w-full text-sm">
                        <option value="1609">1 Mile</option>
                        <option value="4828" selected>3 Miles</option>
                        <option value="8046">5 Miles</option>
                        <option value="16093">10 Miles</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <select id="bar-vibe" class="p-2 w-full text-sm">
                        <option value="bar">üçª All Bars</option>
                        <option value="pub">üç∫ Pubs</option>
                        <option value="nightclub">üï∫ Clubs</option>
                        <option value="lounge">üç∏ Lounge</option>
                        <option value="dive">üé± Dive Bar</option>
                    </select>
                    <select id="bar-budget" class="p-2 w-full text-sm">
                        <option value="4">Any Price</option>
                        <option value="1">$ Cheap</option>
                        <option value="2">$$ Mid</option>
                    </select>
                </div>
                <div class="flex justify-center mb-3">
                    <label class="flex items-center gap-2 justify-center bg-gray-100 border-2 border-black px-4 py-2 rounded-lg cursor-pointer w-full">
                        <input type="checkbox" id="bar-open" class="w-5 h-5 accent-purple-500 rounded border-2 border-black">
                        <span class="text-xs font-black uppercase">Open Now Only</span>
                    </label>
                </div>
                <button onclick="runSearch('bar')" class="w-full py-3 text-sm tracking-wider bg-purple-400 text-white border-3 border-black rounded-full shadow-[4px_4px_0_black] uppercase">Update Bar List</button>
            </div>

            <div id="roulette-bar" class="hidden my-4"><div class="roulette-window"><div id="belt-bar" class="roulette-belt"></div></div></div>
            
            <div id="result-bar" class="hidden cartoon-card p-4 text-center border-purple-400 bg-purple-50">
                <p class="text-[10px] font-black text-purple-600 uppercase tracking-widest mb-1">üéâ DRINK TIME üéâ</p>
                <h2 id="name-bar" class="text-2xl font-black text-gray-900 leading-none mb-2 mt-2" style="font-family: 'Titan One';">--</h2>
                <div id="rating-bar" class="text-orange-500 font-bold text-sm mb-2"></div>
                <p id="details-bar" class="text-gray-600 text-xs font-black mb-4 uppercase tracking-widest">--</p>
                <a id="menu-bar" href="#" target="_blank" class="block w-full bg-purple-500 text-white font-black py-3 rounded-xl border-2 border-black shadow-[3px_3px_0_black] mb-3 flex items-center justify-center gap-2 active:translate-y-1 active:shadow-none transition-all"><span>üìñ DRINK MENU</span></a>
                <div class="grid grid-cols-2 gap-3">
                    <a id="maps-bar" href="#" target="_blank" class="bg-blue-500 text-white text-xs font-black py-3 rounded-xl border-2 border-black shadow-[3px_3px_0_black] active:translate-y-1 active:shadow-none transition-all uppercase block">üó∫Ô∏è Go There</a>
                    <button id="share-bar" class="bg-green-500 text-white text-xs font-black py-3 rounded-xl border-2 border-black shadow-[3px_3px_0_black] active:translate-y-1 active:shadow-none transition-all uppercase">üì§ Share</button>
                </div>
            </div>

            <button id="spin-bar" disabled class="w-full py-5 text-xl tracking-widest mb-4 bg-purple-500 text-white border-3 border-black rounded-full shadow-[4px_4px_0_black] font-black uppercase">SPIN FOR DRINKS!</button>

            <div class="cartoon-card p-4">
                <h3 class="text-xs font-black uppercase mb-3 text-gray-400">üëá Watering Holes</h3>
                <div id="list-bar" class="flex flex-col gap-3 max-h-60 overflow-y-auto pr-1"></div>
            </div>
        </div>

        <div id="view-map" class="tab-view hidden flex flex-col gap-4">
            <div class="cartoon-card p-2">
                <div id="map-container"></div>
                <div class="p-3 text-center flex justify-center items-center gap-2">
                    <span class="w-4 h-4 bg-blue-500 rounded-full border-2 border-white ring-2 ring-black"></span>
                    <p class="text-xs font-black uppercase">You are here</p>
                </div>
            </div>
        </div>

        <div id="view-bill" class="tab-view hidden flex flex-col gap-4">
            <div class="cartoon-card p-5">
                <h3 class="text-sm font-black text-center mb-4 uppercase border-b-2 border-gray-100 pb-2">üí∏ Tab Roulette</h3>
                <div class="grid grid-cols-3 gap-2 mb-4">
                    <div><label class="text-[9px] font-black uppercase ml-1">Total $</label><input type="number" id="bill-total" class="w-full p-2 text-sm"></div>
                    <div><label class="text-[9px] font-black uppercase ml-1">Tip %</label><select id="tip-percent" class="w-full p-2 text-sm"><option value="0.18">18%</option><option value="0.20">20%</option><option value="0.25">25%</option></select></div>
                    <div><label class="text-[9px] font-black uppercase ml-1">People</label><input type="number" id="people-count" class="w-full p-2 text-sm"></div>
                </div>
                <div id="split-result" class="bg-blue-50 border-2 border-black rounded-xl p-4 text-center font-black text-sm uppercase">Waiting...</div>
            </div>
            <div class="cartoon-card p-5">
                <h3 class="text-sm font-black text-center mb-4 uppercase border-b-2 border-gray-100 pb-2">üí≥ Card Roulette</h3>
                <div id="names-grid" class="grid grid-cols-2 gap-2 mb-3 max-h-40 overflow-y-auto">
                    <input type="text" class="payer-input p-2 text-sm" placeholder="Name 1">
                    <input type="text" class="payer-input p-2 text-sm" placeholder="Name 2">
                </div>
                <div class="flex gap-2 mb-4">
                    <button onclick="addNameSlot()" class="flex-1 bg-gray-200 border-2 border-black rounded-lg py-2 text-[10px] font-black uppercase hover:bg-white">+ Add</button>
                    <button onclick="clearNames()" class="flex-1 bg-gray-200 border-2 border-black rounded-lg py-2 text-[10px] font-black uppercase hover:bg-white">Reset</button>
                </div>
                <button id="spin-payer-btn" onclick="spinForPayer()" class="w-full py-4 text-sm bg-green-500 text-white border-3 border-black rounded-full shadow-[4px_4px_0_black] font-black uppercase">Who Pays?</button>
                <div id="payer-result-box" class="hidden p-6 bg-green-500 border-4 border-black text-white rounded-2xl text-center mt-4 pop-in shadow-[4px_4px_0_black]">
                    <h2 id="payer-result-name" class="text-3xl font-black italic" style="font-family: 'Titan One';">--</h2>
                </div>
            </div>
        </div>

        <div id="view-history" class="tab-view hidden flex flex-col gap-4">
            <div class="cartoon-card p-5 min-h-[400px]">
                <h3 class="text-sm font-black text-center mb-4 uppercase border-b-2 border-gray-100 pb-2">üìú Chicken Dinner</h3>
                <div id="history-list" class="flex flex-col gap-3"></div>
            </div>
        </div>
    </main>

    <script>
        // Global State
        let currentMode = 'food';
        let restaurants = [];
        let favs = JSON.parse(localStorage.getItem('jpot_favs') || '[]');
        let history = JSON.parse(localStorage.getItem('jpot_hist') || '[]');
        let lat, lon, currentWinner, map, userMarker, restaurantMarkers = [];

        function switchTab(id) {
            document.querySelectorAll('.tab-view').forEach(v => v.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('view-' + id).classList.remove('hidden');
            document.getElementById('tab-' + id).classList.add('active');
            
            if(id === 'map') setTimeout(() => { if(map) map.invalidateSize(); else initMap(); }, 100);
            if(id === 'history') renderHistory();
        }

        function initMap() {
            if(!lat || !lon) return;
            map = L.map('map-container').setView([lat, lon], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            updateMapMarkers();
        }

        function updateMapMarkers() {
            if(!map) return;
            restaurantMarkers.forEach(m => map.removeLayer(m));
            if(userMarker) map.removeLayer(userMarker);
            restaurantMarkers = [];
            const blueDotIcon = L.divIcon({ className: 'user-location-dot', iconSize: [14, 14] });
            userMarker = L.marker([lat, lon], { icon: blueDotIcon }).addTo(map).bindPopup("<b>You are here</b>");
            restaurants.forEach(p => {
                const m = L.marker([p.lat, p.lon]).addTo(map).bindPopup(`<b>${p.name}</b><br>${p.type}`);
                restaurantMarkers.push(m);
            });
        }

        // --- SEARCH ENGINE WITH IOS FIX ---
        async function runSearch(mode) {
            currentMode = mode;
            const loader = document.getElementById('loader');
            loader.classList.remove('hidden');
            const zip = document.getElementById(mode + '-zip').value.trim();
            
            try {
                if (zip) {
                    const r = await fetch(`https://nominatim.openstreetmap.org/search?postalcode=${zip}&country=US&format=json`);
                    const d = await r.json();
                    if(d.length === 0) throw new Error("Zip code not found.");
                    lat = parseFloat(d[0].lat); lon = parseFloat(d[0].lon);
                } else {
                    // FIX: Retry mechanism for iOS
                    const getPos = (opts) => new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, opts));
                    
                    try {
                        // Attempt 1: High Accuracy
                        const pos = await getPos({ enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
                        lat = pos.coords.latitude; lon = pos.coords.longitude;
                    } catch (err) {
                        // Attempt 2: Low Accuracy / Cached (Fixes 'string pattern' error)
                        console.log("High accuracy failed, trying low accuracy...");
                        const pos = await getPos({ enableHighAccuracy: false, timeout: 10000, maximumAge: 60000 });
                        lat = pos.coords.latitude; lon = pos.coords.longitude;
                    }
                }

                const radius = document.getElementById(mode + '-dist').value;
                let query = "";
                
                if (mode === 'food') {
                    const cuisine = document.getElementById('food-cuisine').value;
                    const filter = cuisine !== 'restaurant' ? `["cuisine"~"${cuisine}"]` : '';
                    query = `[out:json];(node["amenity"~"restaurant|fast_food"]${filter}(around:${radius},${lat},${lon}););out 30;`;
                } else {
                    const vibe = document.getElementById('bar-vibe').value; 
                    const filter = vibe !== 'bar' ? `["amenity"="${vibe}"]` : '["amenity"~"bar|pub|nightclub|lounge|biergarten"]';
                    query = `[out:json];(node${filter}(around:${radius},${lat},${lon}););out 30;`;
                }
                
                const resp = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
                const data = await resp.json();
                
                restaurants = data.elements.filter(e => e.tags.name).map(e => ({
                    id: e.id.toString(),
                    name: e.tags.name,
                    type: (e.tags.amenity || 'Place').replace('_', ' ').toUpperCase(),
                    rating: e.tags.rating || (Math.random() * 1.2 + 3.8).toFixed(1),
                    lat: e.lat, lon: e.lon,
                    hours: e.tags.opening_hours || "Hours not available",
                    dist: calcDist(lat, lon, e.lat, e.lon)
                }));

                renderList(mode);
                if(map) updateMapMarkers();
                document.getElementById('spin-' + mode).disabled = false;
                loader.classList.add('hidden');
                document.getElementById('location-status').innerText = `${restaurants.length} Places Found`;

            } catch(e) { 
                console.error(e);
                alert("Location Error: Please ensure GPS is allowed. If this persists, enter a Zip Code."); 
                loader.classList.add('hidden'); 
            }
        }

        function renderList(mode) {
            document.getElementById('list-' + mode).innerHTML = restaurants.map(p => `
                <div class="hours-row p-3 bg-white border-2 border-black rounded-xl mb-2 shadow-[2px_2px_0_rgba(0,0,0,0.1)]">
                    <div class="flex justify-between items-center mb-2">
                        <div class="w-2/3">
                            <h4 class="font-black text-sm truncate">${p.name}</h4>
                            <p class="text-[9px] uppercase font-bold text-gray-500">${p.type} ‚Ä¢ ${p.dist} mi</p>
                        </div>
                        <div class="flex gap-2">
                            <a href="https://www.google.com/search?q=${encodeURIComponent(p.name + ' Menu')}" target="_blank" class="text-xs bg-gray-100 border border-black px-2 py-1 rounded font-bold hover:bg-yellow-200">üìñ</a>
                            <button onclick="toggleFav('${p.id}')" class="star-btn ${favs.includes(p.id) ? 'text-yellow-500 text-lg' : 'text-gray-300'}">‚òÖ</button>
                        </div>
                    </div>
                    <div>
                         <button onclick="this.parentElement.parentElement.classList.toggle('active')" class="text-[9px] font-black text-blue-500 uppercase flex items-center gap-1 hover:underline">üïí View Hours ‚ñº</button>
                         <div class="hours-content text-[9px] text-gray-600 mt-1 font-bold">${p.hours}</div>
                    </div>
                </div>`).join('');
        }

        // --- SPIN LOGIC ---
        function setupSpin(mode) {
            document.getElementById('spin-' + mode).onclick = () => {
                const pool = [];
                restaurants.forEach(p => { pool.push(p); if(favs.includes(p.id)) pool.push(p); });
                currentWinner = pool[Math.floor(Math.random() * pool.length)];
                
                const area = document.getElementById('roulette-' + mode);
                const belt = document.getElementById('belt-' + mode);
                const btn = document.getElementById('spin-' + mode);
                
                area.classList.remove('hidden');
                document.getElementById('result-' + mode).classList.add('hidden');
                
                let items = "";
                for(let i=0; i<30; i++) items += `<div class="roulette-item text-xs">${pool[i % pool.length].name}</div>`;
                items += `<div class="roulette-item text-red-500 font-black">${currentWinner.name}</div>`;
                belt.innerHTML = items;
                
                document.documentElement.style.setProperty('--scroll-distance', `-${30 * 100}px`);
                belt.classList.add('spinning');
                
                belt.addEventListener('animationend', () => {
                    area.classList.add('hidden');
                    belt.classList.remove('spinning');
                    
                    document.getElementById('name-' + mode).innerText = currentWinner.name;
                    document.getElementById('rating-' + mode).innerText = "‚≠ê".repeat(Math.floor(currentWinner.rating));
                    document.getElementById('details-' + mode).innerText = `${currentWinner.type} ‚Ä¢ ${currentWinner.dist} MILES`;
                    document.getElementById('maps-' + mode).href = `http://googleusercontent.com/maps.google.com/?q=${currentWinner.lat},${currentWinner.lon}`;
                    document.getElementById('menu-' + mode).href = `https://www.google.com/search?q=${encodeURIComponent(currentWinner.name + ' Menu')}`;
                    
                    document.getElementById('result-' + mode).classList.remove('hidden');
                    
                    // UPDATE BUTTON TEXT
                    btn.innerText = "ROLL AGAIN";
                    
                    saveToHist(currentWinner);
                }, {once: true});
            };
            
            document.getElementById('share-' + mode).onclick = async () => {
                if(currentWinner && navigator.share) await navigator.share({ title: 'Jackpot Winner', text: `Let's go to: ${currentWinner.name}`, url: `http://googleusercontent.com/maps.google.com/?q=${currentWinner.lat},${currentWinner.lon}` });
            };
        }
        setupSpin('food');
        setupSpin('bar');

        function updateSplit() {
            const t = parseFloat(document.getElementById('bill-total').value)||0, tp = parseFloat(document.getElementById('tip-percent').value), n = parseInt(document.getElementById('people-count').value)||0;
            if(t>0&&n>0) document.getElementById('split-result').innerText = `TOTAL: $${(t*(1+tp)).toFixed(2)} | $${(t*(1+tp)/n).toFixed(2)} EACH`;
        }
        ['bill-total','tip-percent','people-count'].forEach(id=>document.getElementById(id).addEventListener('input',updateSplit));

        function spinForPayer() {
            const names = Array.from(document.querySelectorAll('.payer-input')).map(i=>i.value.trim()).filter(n=>n!=="");
            if(names.length<2) return alert("Need 2+ players");
            document.getElementById('payer-result-box').classList.remove('hidden');
            let t = setInterval(() => { document.getElementById('payer-result-name').innerText = names[Math.floor(Math.random()*names.length)]; }, 70);
            setTimeout(() => clearInterval(t), 2000);
        }

        function addNameSlot() {
            const grid = document.getElementById('names-grid');
            if(grid.children.length < 10) {
                const i = document.createElement('input');
                i.className = "payer-input p-2 text-sm border-2 border-black rounded-lg font-bold bg-white";
                i.placeholder = `Name ${grid.children.length + 1}`;
                grid.appendChild(i);
            }
        }
        function clearNames() { 
            document.getElementById('names-grid').innerHTML = `<input type="text" class="payer-input p-2 text-sm" placeholder="Name 1"><input type="text" class="payer-input p-2 text-sm" placeholder="Name 2">`;
            document.getElementById('payer-result-box').classList.add('hidden');
        }

        function saveToHist(p) { 
            history.unshift({ name: p.name, rating: p.rating, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) }); 
            if(history.length>20) history.pop(); 
            localStorage.setItem('jpot_hist', JSON.stringify(history)); 
        }

        function renderHistory() { 
            const list = document.getElementById('history-list');
            if(history.length === 0) { list.innerHTML = "<p class='text-center text-xs text-gray-400 font-bold'>No history yet!</p>"; return; }
            list.innerHTML = history.map(h => `
                <div class="p-3 bg-white border-2 border-black rounded-xl flex justify-between items-center shadow-[2px_2px_0_black]">
                    <div><h4 class="font-black text-[11px] truncate w-32">${h.name}</h4><p class="text-[9px] text-orange-500 font-bold">‚≠ê ${h.rating || '--'} ‚Ä¢ ${h.time}</p></div>
                    <a href="https://www.google.com/search?q=${encodeURIComponent(h.name + ' Menu')}" target="_blank" class="text-[9px] bg-yellow-200 border border-black px-2 py-1 rounded font-black hover:bg-yellow-300 uppercase">üìñ Menu</a>
                </div>`).join('');
        }

        function toggleFav(id) { 
            const i = favs.indexOf(id); if(i>-1) favs.splice(i,1); else favs.push(id); 
            localStorage.setItem('jpot_favs', JSON.stringify(favs)); 
            if(restaurants.length > 0) renderList(currentMode); 
        }
        
        function calcDist(la1,lo1,la2,lo2) { 
            const R=3958.8, dLa=(la2-la1)*Math.PI/180, dLo=(lo2-lo1)*Math.PI/180, a=Math.sin(dLa/2)**2+Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dLo/2)**2; 
            return (R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))).toFixed(1); 
        }
    </script>
</body>
</html>
