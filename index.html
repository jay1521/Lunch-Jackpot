<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bite Roulette</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Titan+One&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-cream: #FFF8E1;
            --accent-orange: #FF8A65;
            --accent-red: #FF5252;
            --accent-blue: #4FC3F7;
            --accent-green: #81C784;
            --accent-purple: #BA68C8;
            --accent-brown: #8D6E63;
            --border-color: #1a1a1a;
        }

        body {
            background-color: var(--bg-cream);
            background-image: radial-gradient(#FFE0B2 2px, transparent 2px);
            background-size: 20px 20px;
            font-family: 'Nunito', sans-serif;
            color: var(--border-color);
        }

        h1, h2, h3, .tab-btn { font-family: 'Titan One', cursive; letter-spacing: 1px; }

        .cartoon-card {
            background: white;
            border: 3px solid var(--border-color);
            border-radius: 16px;
            box-shadow: 6px 6px 0px 0px rgba(0,0,0,0.8);
            margin-bottom: 16px;
        }
        
        input, select {
            border: 2px solid var(--border-color) !important;
            background: #fff !important;
            border-radius: 12px !important;
            font-weight: 800 !important;
            box-shadow: 2px 2px 0px 0px rgba(0,0,0,0.2);
        }
        
        button { font-family: 'Titan One', cursive; }
        
        .tab-btn { color: #555; border: 2px solid transparent; }
        .tab-btn.active {
            background: var(--accent-blue);
            color: white;
            border: 3px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 3px 3px 0px 0px #000;
            transform: translateY(-2px);
        }
        #tab-bar.active { background: var(--accent-purple); }
        #tab-coffee.active { background: var(--accent-brown); }

        /* WHEEL SPECIFIC STYLES */
        .wheel-container {
            position: relative;
            width: 100%;
            padding-bottom: 100%; /* Aspect Ratio 1:1 */
            margin: 10px 0;
            filter: drop-shadow(0px 10px 0px rgba(0,0,0,0.2));
        }
        
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 4px solid #1a1a1a;
            background: #fff;
            transition: transform 5s cubic-bezier(0.1, 0.7, 0.1, 1);
        }

        .wheel-pointer {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 70px;
            height: 70px;
            z-index: 20;
            filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.5));
            pointer-events: none;
        }

        .wheel-center-nut {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20%;
            height: 20%;
            background: #FFD54F;
            border: 3px solid #1a1a1a;
            border-radius: 50%;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 2px 2px 5px rgba(255,255,255,0.5), 2px 2px 0px rgba(0,0,0,0.5);
        }
        
        .user-location-dot { width: 16px; height: 16px; background-color: var(--accent-blue); border: 3px solid white; border-radius: 50%; box-shadow: 0 0 0 2px black; position: relative; }
        #map-container { height: 400px; width: 100%; border-radius: 12px; border: 3px solid var(--border-color); overflow: hidden; }
        
        .hours-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .hours-row.active .hours-content { max-height: 120px; overflow-y: auto; }
        .cartoon-title { color: var(--accent-orange); -webkit-text-stroke: 1.5px black; text-shadow: 3px 3px 0px #000; }
    </style>
</head>
<body class="min-h-screen pb-44">

    <header class="w-full max-w-md mx-auto p-6 text-center">
        <h1 class="text-4xl cartoon-title mb-2">BITE<br>ROULETTE</h1>
        <div class="inline-block bg-white border-2 border-black rounded-full px-4 py-1 shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]">
            <div class="flex items-center gap-2">
                <div id="loader" class="loader hidden w-3 h-3 border-2 border-black border-t-transparent rounded-full animate-spin"></div>
                <span id="location-status" class="text-[10px] font-black uppercase text-black">Ready to Spin</span>
            </div>
        </div>
    </header>

    <nav class="fixed bottom-4 left-1/2 -translate-x-1/2 w-[98%] max-w-md bg-white border-4 border-black rounded-2xl p-2 z-[1000] shadow-[6px_6px_0px_0px_rgba(0,0,0,1)]">
        <div class="flex flex-wrap justify-center gap-1">
            <button onclick="switchTab('jackpot')" id="tab-jackpot" class="tab-btn active flex-grow w-[30%] py-2 text-[8px] font-black uppercase">üçî Food</button>
            <button onclick="switchTab('bar')" id="tab-bar" class="tab-btn flex-grow w-[30%] py-2 text-[8px] font-black uppercase">üç∏ 21+</button>
            <button onclick="switchTab('coffee')" id="tab-coffee" class="tab-btn flex-grow w-[30%] py-2 text-[8px] font-black uppercase">‚òï Coffee</button>
            
            <button onclick="switchTab('bill')" id="tab-bill" class="tab-btn flex-grow w-[30%] py-2 text-[8px] font-black uppercase">üí∏ Tab</button>
            <button onclick="switchTab('history')" id="tab-history" class="tab-btn flex-grow w-[30%] py-2 text-[8px] font-black uppercase">üìú History</button>
            <button onclick="switchTab('map')" id="tab-map" class="tab-btn flex-grow w-[30%] py-2 text-[8px] font-black uppercase">üó∫Ô∏è Map</button>
        </div>
    </nav>

    <main class="w-full max-w-md mx-auto px-4">
        
        <div id="view-jackpot" class="tab-view flex flex-col gap-4">
            <div class="cartoon-card p-4">
                <h3 class="text-xs font-black uppercase mb-2 text-center text-blue-400">üçî Dine & Dice</h3>
                
                <div class="mb-3">
                    <input type="text" id="food-custom" placeholder="Variable Code (e.g. Ramen, Tacos, Vegan)" class="p-2 w-full text-sm border-dashed border-gray-400">
                    <p class="text-[9px] text-gray-400 text-center mt-1 font-bold uppercase">Leave empty to use categories below</p>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-3">
                    <input type="text" id="food-zip" placeholder="Zip Code" class="p-2 w-full text-sm">
                    <select id="food-dist" class="p-2 w-full text-sm">
                        <option value="1609">1 Mile</option>
                        <option value="4828" selected>3 Miles</option>
                        <option value="8046">5 Miles</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <select id="food-cuisine" class="p-2 w-full text-sm">
                        <option value="restaurant">üé° All Food</option>
                        <option value="healthy">ü•ó Healthy</option>
                        <option value="comfort">üçó Comfort</option>
                        <option value="pizza">üçï Pizza</option>
                        <option value="burger">üçî Burger</option>
                        <option value="mexican">üåÆ Mexican</option>
                        <option value="asian">üç£ Asian/Sushi</option>
                        <option value="italian">üçù Italian</option>
                        <option value="breakfast">ü•û Breakfast</option>
                    </select>
                    <select id="food-budget" class="p-2 w-full text-sm">
                        <option value="4">Any Price</option>
                        <option value="1">$ Cheap</option>
                        <option value="2">$$ Mid</option>
                    </select>
                </div>
                <button onclick="runSearch('food')" class="w-full py-3 text-sm tracking-wider bg-blue-400 text-white border-3 border-black rounded-full shadow-[4px_4px_0_black] uppercase">Update List</button>
            </div>

            <div id="roulette-food-area" class="hidden mb-4 px-4">
                <div class="wheel-container">
                    <canvas id="wheel-canvas-food"></canvas>
                    <svg class="wheel-pointer" viewBox="0 0 100 100" style="overflow: visible;">
                        <g transform="translate(50, 45)">
                            <path d="M70,-20 L30,40" stroke="#FF5252" stroke-width="8" stroke-linecap="round"/>
                            <path d="M30,40 L25,48" stroke="#1a1a1a" stroke-width="8" stroke-linecap="round"/>
                            <path d="M30,-20 L70,40" stroke="#FF5252" stroke-width="8" stroke-linecap="round"/>
                            <path d="M70,40 L75,48" stroke="#1a1a1a" stroke-width="8" stroke-linecap="round"/>
                            <path d="M25,-25 L35,-15 M28,-28 L38,-18 M31,-31 L41,-21" stroke="#1a1a1a" stroke-width="2"/>
                            <path d="M70,-20 L30,40 M30,-20 L70,40" stroke="black" stroke-width="2" fill="none"/>
                        </g>
                    </svg>
                    <div class="wheel-center-nut"><div class="w-2 h-2 bg-black rounded-full opacity-20"></div></div>
                </div>
            </div>
            
            <div id="result-food" class="hidden cartoon-card p-4 text-center border-yellow-400 bg-yellow-50">
                <p class="text-[10px] font-black text-yellow-600 uppercase tracking-widest mb-1">üéâ WINNER üéâ</p>
                <h2 id="name-food" class="text-2xl font-black text-gray-900 leading-none mb-2 mt-2" style="font-family: 'Titan One';">--</h2>
                <div id="rating-food" class="text-orange-500 font-bold text-sm mb-2"></div>
                <p id="details-food" class="text-gray-600 text-xs font-black mb-4 uppercase tracking-widest">--</p>
                <a id="menu-food" href="#" target="_blank" class="block w-full bg-orange-400 text-white font-black py-3 rounded-xl border-2 border-black shadow-[3px_3px_0_black] mb-3 flex items-center justify-center gap-2"><span>üìñ VIEW MENU</span></a>
                <div class="grid grid-cols-2 gap-3">
                    <a id="maps-food" href="#" target="_blank" class="bg-blue-500 text-white text-xs font-black py-3 rounded-xl border-2 border-black shadow-[3px_3px_0_black] uppercase block">üó∫Ô∏è Go There</a>
                    <button id="share-food" class="bg-green-500 text-white text-xs font-black py-3 rounded-xl border-2 border-black shadow-[3px_3px_0_black] uppercase">üì§ Share</button>
                </div>
            </div>

            <button id="spin-food" disabled class="w-full py-5 text-xl tracking-widest mb-4 bg-red-500 text-white border-3 border-black rounded-full shadow-[4px_4px_0_black] font-black uppercase">SPIN THE WHEEL!</button>
            <div class="cartoon-card p-4">
                <h3 class="text-xs font-black uppercase mb-3 text-gray-400">üëá Candidates</h3>
                <div id="list-food" class="flex flex-col gap-3 max-h-60 overflow-y-auto pr-1"></div>
            </div>
        </div>

        <div id="view-bar" class="tab-view hidden flex flex-col gap-4">
            <div class="cartoon-card p-4 border-purple-900">
                <h3 class="text-xs font-black uppercase mb-2 text-center text-purple-600">üç∏ 21+ Only</h3>
                
                <div class="mb-3">
                    <input type="text" id="bar-custom" placeholder="Specific Drink (e.g. Margarita, Craft Beer)" class="p-2 w-full text-sm border-dashed border-gray-400">
                </div>

                <div class="grid grid-cols-2 gap-3 mb-3">
                    <input type="text" id="bar-zip" placeholder="Zip Code" class="p-2 w-full text-sm">
                    <select id="bar-dist" class="p-2 w-full text-sm">
                        <option value="1609">1 Mile</option>
                        <option value="4828" selected>3 Miles</option>
                        <option value="8046">5 Miles</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <select id="bar-vibe" class="p-2 w-full text-sm">
                        <option value="bar">üçª All Bars</option>
                        <option value="pub">üç∫ Pubs</option>
                        <option value="nightclub">üï∫ Clubs</option>
                        <option value="lounge">üç∏ Lounge</option>
                        <option value="dive">üé± Dive Bar</option>
                    </select>
                    <select id="bar-budget" class="p-2 w-full text-sm">
                        <option value="4">Any Price</option>
                        <option value="1">$ Cheap</option>
                        <option value="2">$$ Mid</option>
                    </select>
                </div>
                <button onclick="runSearch('bar')" class="w-full py-3 text-sm tracking-wider bg-purple-400 text-white border-3 border-black rounded-full shadow-[4px_4px_0_black] uppercase">Update Bar List</button>
            </div>

             <div id="roulette-bar-area" class="hidden mb-4 px-4">
                <div class="wheel-container">
                    <canvas id="wheel-canvas-bar"></canvas>
                    <svg class="wheel-pointer" viewBox="0 0 100 100" style="overflow: visible;">
                        <g transform="translate(50, 60)">
                            <path d="M-25,-40 L25,-40 L0,0 Z" fill="#BA68C8" stroke="#1a1a1a" stroke-width="3" fill-opacity="0.6"/>
                            <path d="M0,0 L0,30" stroke="#1a1a1a" stroke-width="4"/>
                            <path d="M-15,30 L15,30" stroke="#1a1a1a" stroke-width="4" stroke-linecap="round"/>
                            <circle cx="0" cy="-20" r="5" fill="#81C784" stroke="#1a1a1a" stroke-width="2"/>
                            <path d="M0,-20 L10,-30" stroke="#1a1a1a" stroke-width="2"/>
                        </g>
                    </svg>
                    <div class="wheel-center-nut"><div class="w-2 h-2 bg-black rounded-full opacity-20"></div></div>
                </div>
            </div>
            
            <div id="result-bar" class="hidden cartoon-card p-4 text-center border-purple-400 bg-purple-50">
                <p class="text-[10px] font-black text-purple-600 uppercase tracking-widest mb-1">üéâ DRINK TIME üéâ</p>
                <h2 id="name-bar" class="text-2xl font-black text-gray-900 leading-none mb-2 mt-2" style="font-family: 'Titan One';">--</h2>
                <div id="rating-bar" class="text-orange-500 font-bold text-sm mb-2"></div>
                <p id="details-bar" class="text-gray-600 text-xs font-black mb-4 uppercase tracking-widest">--</p>
                <a id="menu-bar" href="#" target="_blank" class="block w-full bg-purple-500 text-white font-black py-3 rounded-xl border-2 border-black shadow-[3px_3px_0_black] mb-3 flex items-center justify-center gap-2"><span>üìñ DRINK MENU</span></a>
                <div class="grid grid-cols-2 gap-3">
                    <a id="maps-bar" href="#" target="_blank" class="bg-blue-500 text-white text-xs font-black py-3 rounded-xl border-2 border-black shadow-[3px_3px_0_black] uppercase block">üó∫Ô∏è Go There</a>
                    <button id="share-bar" class="bg-green-500 text-white text-xs font-black py-3 rounded-xl border-2 border-black shadow-[3px_3px_0_black] uppercase">üì§ Share</button>
                </div>
            </div>

            <button id="spin-bar" disabled class="w-full py-5 text-xl tracking-widest mb-4 bg-purple-500 text-white border-3 border-black rounded-full shadow-[4px_4px_0_black] font-black uppercase">SPIN THE WHEEL!</button>
            <div class="cartoon-card p-4">
                <h3 class="text-xs font-black uppercase mb-3 text-gray-400">üëá Watering Holes</h3>
                <div id="list-bar" class="flex flex-col gap-3 max-h-60 overflow-y-auto pr-1"></div>
            </div>
        </div>

        <div id="view-coffee" class="tab-view hidden flex flex-col gap-4">
            <div class="cartoon-card p-4 border-amber-900">
                <h3 class="text-xs font-black uppercase mb-2 text-center text-amber-700">‚òï Coffee & Tea</h3>
                
                <div class="mb-3">
                    <input type="text" id="coffee-custom" placeholder="Cravings (e.g. Matcha, Donuts, Boba)" class="p-2 w-full text-sm border-dashed border-gray-400">
                </div>

                <div class="grid grid-cols-2 gap-3 mb-3">
                    <input type="text" id="coffee-zip" placeholder="Zip Code" class="p-2 w-full text-sm">
                    <select id="coffee-dist" class="p-2 w-full text-sm">
                        <option value="1609">1 Mile</option>
                        <option value="4828" selected>3 Miles</option>
                        <option value="8046">5 Miles</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <select id="coffee-type" class="p-2 w-full text-sm">
                        <option value="cafe">‚òï All Cafes</option>
                        <option value="bakery">ü•ê Bakery</option>
                        <option value="tea">üçµ Tea House</option>
                        <option value="boba">üßã Boba Tea</option>
                        <option value="donut">üç© Donuts</option>
                    </select>
                    <label class="flex items-center gap-2 justify-center bg-gray-100 border-2 border-black px-2 py-2 rounded-lg cursor-pointer w-full">
                        <input type="checkbox" id="coffee-open" class="w-4 h-4 accent-amber-500 rounded border-2 border-black">
                        <span class="text-[10px] font-black uppercase">Open Now</span>
                    </label>
                </div>
                <button onclick="runSearch('coffee')" class="w-full py-3 text-sm tracking-wider bg-amber-500 text-white border-3 border-black rounded-full shadow-[4px_4px_0_black] uppercase">Find Caffeine</button>
            </div>

            <div id="roulette-coffee-area" class="hidden mb-4 px-4">
                <div class="wheel-container">
                    <canvas id="wheel-canvas-coffee"></canvas>
                    <svg class="wheel-pointer" viewBox="0 0 100 100" style="overflow: visible;">
                        <g transform="translate(50, 50)">
                            <path d="M-20,-10 L-20,20 C-20,35 20,35 20,20 L20,-10 Z" fill="#8D6E63" stroke="#1a1a1a" stroke-width="3"/>
                            <path d="M20,0 C30,0 30,15 20,15" fill="none" stroke="#1a1a1a" stroke-width="3"/>
                            <path d="M-10,-20 Q-15,-30 -10,-40" stroke="#aaa" stroke-width="2" fill="none"/>
                            <path d="M0,-20 Q-5,-30 0,-40" stroke="#aaa" stroke-width="2" fill="none"/>
                            <path d="M10,-20 Q5,-30 10,-40" stroke="#aaa" stroke-width="2" fill="none"/>
                        </g>
                    </svg>
                    <div class="wheel-center-nut"><div class="w-2 h-2 bg-black rounded-full opacity-20"></div></div>
                </div>
            </div>

            <div id="result-coffee" class="hidden cartoon-card p-4 text-center border-amber-400 bg-amber-50">
                <p class="text-[10px] font-black text-amber-700 uppercase tracking-widest mb-1">üéâ WAKE UP! üéâ</p>
                <h2 id="name-coffee" class="text-2xl font-black text-gray-900 leading-none mb-2 mt-2" style="font-family: 'Titan One';">--</h2>
                <div id="rating-coffee" class="text-orange-500 font-bold text-sm mb-2"></div>
                <p id="details-coffee" class="text-gray-600 text-xs font-black mb-4 uppercase tracking-widest">--</p>
                <a id="menu-coffee" href="#" target="_blank" class="block w-full bg-amber-600 text-white font-black py-3 rounded-xl border-2 border-black shadow-[3px_3px_0_black] mb-3 flex items-center justify-center gap-2"><span>üìñ VIEW MENU</span></a>
                <div class="grid grid-cols-2 gap-3">
                    <a id="maps-coffee" href="#" target="_blank" class="bg-blue-500 text-white text-xs font-black py-3 rounded-xl border-2 border-black shadow-[3px_3px_0_black] uppercase block">üó∫Ô∏è Go There</a>
                    <button id="share-coffee" class="bg-green-500 text-white text-xs font-black py-3 rounded-xl border-2 border-black shadow-[3px_3px_0_black] uppercase">üì§ Share</button>
                </div>
            </div>
            
            <button id="spin-coffee" disabled class="w-full py-5 text-xl tracking-widest mb-4 bg-amber-600 text-white border-3 border-black rounded-full shadow-[4px_4px_0_black] font-black uppercase">SPIN THE WHEEL!</button>
            <div class="cartoon-card p-4">
                <h3 class="text-xs font-black uppercase mb-3 text-gray-400">üëá Caffeine Spots</h3>
                <div id="list-coffee" class="flex flex-col gap-3 max-h-60 overflow-y-auto pr-1"></div>
            </div>
        </div>

        <div id="view-map" class="tab-view hidden flex flex-col gap-4">
            <div class="cartoon-card p-2"><div id="map-container"></div></div>
        </div>
        <div id="view-bill" class="tab-view hidden flex flex-col gap-4">
             <div class="cartoon-card p-5">
                <h3 class="text-sm font-black text-center mb-4 uppercase border-b-2 border-gray-100 pb-2">üí∏ Tab Roulette</h3>
                <div class="grid grid-cols-3 gap-2 mb-4">
                    <div><label class="text-[9px] font-black uppercase ml-1">Total $</label><input type="number" id="bill-total" class="w-full p-2 text-sm"></div>
                    <div><label class="text-[9px] font-black uppercase ml-1">Tip %</label><select id="tip-percent" class="w-full p-2 text-sm"><option value="0.18">18%</option><option value="0.20">20%</option></select></div>
                    <div><label class="text-[9px] font-black uppercase ml-1">People</label><input type="number" id="people-count" class="w-full p-2 text-sm"></div>
                </div>
                <div id="split-result" class="bg-blue-50 border-2 border-black rounded-xl p-4 text-center font-black text-sm uppercase">Waiting...</div>
            </div>
        </div>
        <div id="view-history" class="tab-view hidden flex flex-col gap-4">
            <div class="cartoon-card p-5 min-h-[400px]">
                <h3 class="text-sm font-black text-center mb-4 uppercase border-b-2 border-gray-100 pb-2">üìú Chicken Dinner</h3>
                <div id="history-list" class="flex flex-col gap-3"></div>
            </div>
        </div>
    </main>

    <script>
        // Global State
        let currentMode = 'food';
        let restaurants = [];
        let favs = JSON.parse(localStorage.getItem('jpot_favs') || '[]');
        let history = JSON.parse(localStorage.getItem('jpot_hist') || '[]');
        let lat, lon, currentWinner, map, userMarker, restaurantMarkers = [];

        // Colors from the image: Yellow, Blue, Red, Green, Purple, Cyan
        const WHEEL_COLORS = ['#FFEB3B', '#42A5F5', '#EF5350', '#66BB6A', '#AB47BC', '#26C6DA'];
        const DRINK_ICONS = ['üç∏', 'üç∫', 'üç∑', 'üçπ', 'ü•É', 'üç∂', 'ü•Ç'];

        function switchTab(id) {
            document.querySelectorAll('.tab-view').forEach(v => v.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('view-' + id).classList.remove('hidden');
            document.getElementById('tab-' + id).classList.add('active');
            
            if(id === 'map') setTimeout(() => { if(map) map.invalidateSize(); else initMap(); }, 100);
            if(id === 'history') renderHistory();
        }

        function initMap() {
            if(!lat || !lon) return;
            map = L.map('map-container').setView([lat, lon], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            updateMapMarkers();
        }

        function updateMapMarkers() {
            if(!map) return;
            restaurantMarkers.forEach(m => map.removeLayer(m));
            if(userMarker) map.removeLayer(userMarker);
            restaurantMarkers = [];
            const blueDotIcon = L.divIcon({ className: 'user-location-dot', iconSize: [14, 14] });
            userMarker = L.marker([lat, lon], { icon: blueDotIcon }).addTo(map).bindPopup("<b>You are here</b>");
            restaurants.forEach(p => {
                const m = L.marker([p.lat, p.lon]).addTo(map).bindPopup(`<b>${p.name}</b><br>${p.type}`);
                restaurantMarkers.push(m);
            });
        }

        // --- SEARCH ENGINE ---
        async function runSearch(mode) {
            currentMode = mode;
            const loader = document.getElementById('loader');
            loader.classList.remove('hidden');
            const zip = document.getElementById(mode + '-zip').value.trim();
            const customQuery = document.getElementById(mode + '-custom') ? document.getElementById(mode + '-custom').value.trim() : "";
            
            try {
                if (zip) {
                    const r = await fetch(`https://nominatim.openstreetmap.org/search?postalcode=${zip}&country=US&format=json`);
                    const d = await r.json();
                    if(d.length === 0) throw new Error("Zip code not found.");
                    lat = parseFloat(d[0].lat); lon = parseFloat(d[0].lon);
                } else {
                    const getPos = (opts) => new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, opts));
                    try {
                        const pos = await getPos({ enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
                        lat = pos.coords.latitude; lon = pos.coords.longitude;
                    } catch (err) {
                        const pos = await getPos({ enableHighAccuracy: false, timeout: 10000, maximumAge: 60000 });
                        lat = pos.coords.latitude; lon = pos.coords.longitude;
                    }
                }

                const radius = document.getElementById(mode + '-dist').value;
                let query = "";
                
                // --- MODE LOGIC ---
                if (mode === 'food') {
                    if (customQuery) {
                        query = `[out:json];(node["amenity"~"restaurant|fast_food|cafe"]["name"~"${customQuery}",i](around:${radius},${lat},${lon});node["cuisine"~"${customQuery}",i](around:${radius},${lat},${lon}););out 30;`;
                    } else {
                        const cuisine = document.getElementById('food-cuisine').value;
                        let filter = '';
                        if(cuisine === 'healthy') filter = `["cuisine"~"vegetarian|vegan|salad|poke|smoothie"]`;
                        else if(cuisine === 'comfort') filter = `["cuisine"~"diner|bbq|soul_food|fried_chicken|steak_house"]`;
                        else if(cuisine === 'asian') filter = `["cuisine"~"japanese|chinese|thai|vietnamese|sushi|ramen"]`;
                        else if(cuisine === 'breakfast') filter = `["cuisine"~"breakfast|pancake|coffee_shop|bagel"]`;
                        else if(cuisine === 'italian') filter = `["cuisine"~"italian|pizza|pasta"]`;
                        else if(cuisine !== 'restaurant') filter = `["cuisine"~"${cuisine}"]`;
                        query = `[out:json];(node["amenity"~"restaurant|fast_food|cafe"]${filter}(around:${radius},${lat},${lon}););out 30;`;
                    }
                } else if (mode === 'bar') {
                    if (customQuery) {
                         query = `[out:json];(node["amenity"~"bar|pub|nightclub|lounge"]["name"~"${customQuery}",i](around:${radius},${lat},${lon}););out 30;`;
                    } else {
                        const vibe = document.getElementById('bar-vibe').value; 
                        const filter = vibe !== 'bar' ? `["amenity"="${vibe}"]` : `["amenity"~"^(bar|pub|nightclub|lounge|biergarten)$"]`;
                        query = `[out:json];(node${filter}(around:${radius},${lat},${lon}););out 30;`;
                    }
                } else if (mode === 'coffee') {
                    if (customQuery) {
                         query = `[out:json];(node["amenity"~"cafe"]["name"~"${customQuery}",i](around:${radius},${lat},${lon});node["cuisine"~"${customQuery}",i](around:${radius},${lat},${lon}););out 30;`;
                    } else {
                         const type = document.getElementById('coffee-type').value;
                         let filter = `["amenity"="cafe"]`; // Default
                         if (type === 'bakery') filter = `["shop"="bakery"]`;
                         else if (type === 'tea') filter = `["cuisine"~"tea"]`;
                         else if (type === 'boba') filter = `["cuisine"~"bubble_tea"]`;
                         else if (type === 'donut') filter = `["cuisine"~"donut"]`;
                         query = `[out:json];(node${filter}(around:${radius},${lat},${lon}););out 30;`;
                    }
                }
                
                const resp = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
                const data = await resp.json();
                
                restaurants = data.elements.filter(e => e.tags.name).map(e => ({
                    id: e.id.toString(),
                    name: e.tags.name,
                    rawCuisine: e.tags.cuisine || e.tags.amenity,
                    type: (e.tags.cuisine || e.tags.amenity || 'Place').replace(/_/g, ' ').toUpperCase(),
                    rating: e.tags.rating || (Math.random() * 1.2 + 3.8).toFixed(1),
                    lat: e.lat, lon: e.lon,
                    hours: e.tags.opening_hours || "Hours not available",
                    dist: calcDist(lat, lon, e.lat, e.lon)
                }));

                renderList(mode);
                if(map) updateMapMarkers();
                document.getElementById('spin-' + mode).disabled = false;
                loader.classList.add('hidden');
                document.getElementById('location-status').innerText = `${restaurants.length} Places Found`;
                document.getElementById('roulette-'+mode+'-area').classList.add('hidden');
                document.getElementById('result-'+mode).classList.add('hidden');

            } catch(e) { 
                console.error(e);
                alert("Location Error: Please ensure GPS is allowed or enter a Zip Code."); 
                loader.classList.add('hidden'); 
            }
        }

        function renderList(mode) {
            document.getElementById('list-' + mode).innerHTML = restaurants.map(p => `
                <div class="hours-row p-3 bg-white border-2 border-black rounded-xl mb-2 shadow-[2px_2px_0_rgba(0,0,0,0.1)]">
                    <div class="flex justify-between items-center mb-2">
                        <div class="w-2/3">
                            <h4 class="font-black text-sm truncate">${p.name}</h4>
                            <p class="text-[9px] uppercase font-bold text-gray-500">${getIconForType(p.rawCuisine, mode)} ${p.type} ‚Ä¢ ${p.dist} mi</p>
                        </div>
                        <div class="flex gap-2">
                            <a href="https://www.google.com/search?q=${encodeURIComponent(p.name + ' Menu')}" target="_blank" class="text-xs bg-gray-100 border border-black px-2 py-1 rounded font-bold hover:bg-yellow-200">üìñ</a>
                            <button onclick="toggleFav('${p.id}')" class="star-btn ${favs.includes(p.id) ? 'text-yellow-500 text-lg' : 'text-gray-300'}">‚òÖ</button>
                        </div>
                    </div>
                    <div>
                         <button onclick="this.parentElement.parentElement.classList.toggle('active')" class="text-[9px] font-black text-blue-500 uppercase flex items-center gap-1 hover:underline">üïí View Hours ‚ñº</button>
                         <div class="hours-content text-[9px] text-gray-600 mt-1 font-bold">${p.hours}</div>
                    </div>
                </div>`).join('');
        }

        // --- ICON LOGIC ---
        function getIconForType(type, mode) {
            // STRICT MODE for Bar: Only drinks
            if (mode === 'bar') {
                return DRINK_ICONS[Math.floor(Math.random() * DRINK_ICONS.length)];
            }

            if(!type) return mode === 'coffee' ? '‚òï' : 'üçΩÔ∏è';
            const t = type.toLowerCase();
            
            // Coffee/Tea specific
            if(t.includes('coffee') || t.includes('cafe')) return '‚òï';
            if(t.includes('tea')) return 'üçµ';
            if(t.includes('bubble') || t.includes('boba')) return 'üßã';
            if(t.includes('bakery') || t.includes('donut')) return 'üç©';

            // Food
            if(t.includes('pizza')) return 'üçï';
            if(t.includes('burger')) return 'üçî';
            if(t.includes('taco') || t.includes('mexican')) return 'üåÆ';
            if(t.includes('sushi') || t.includes('japanese')) return 'üç£';
            if(t.includes('noodle') || t.includes('ramen') || t.includes('thai')) return 'üçú';
            if(t.includes('ice_cream') || t.includes('dessert')) return 'üç¶';
            if(t.includes('salad') || t.includes('vegetarian') || t.includes('healthy')) return 'ü•ó';
            if(t.includes('steak') || t.includes('bbq')) return 'ü•©';
            return 'üçΩÔ∏è';
        }

        // --- WHEEL LOGIC ---
        function drawWheel(canvasId, items, rotationAngle, mode) {
            const canvas = document.getElementById(canvasId);
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth * 2; 
            const height = canvas.height = canvas.offsetHeight * 2;
            const cx = width / 2;
            const cy = height / 2;
            const radius = width / 2 - 10;
            const sliceAngle = (2 * Math.PI) / items.length;

            ctx.clearRect(0, 0, width, height);
            
            items.forEach((item, i) => {
                const startAngle = rotationAngle + i * sliceAngle;
                const endAngle = startAngle + sliceAngle;

                ctx.beginPath();
                ctx.moveTo(cx, cy);
                ctx.arc(cx, cy, radius, startAngle, endAngle);
                ctx.closePath();
                
                ctx.fillStyle = WHEEL_COLORS[i % WHEEL_COLORS.length];
                ctx.fill();
                ctx.lineWidth = 4;
                ctx.strokeStyle = "#1a1a1a";
                ctx.stroke();

                ctx.save();
                ctx.translate(cx, cy);
                ctx.rotate(startAngle + sliceAngle / 2);
                ctx.textAlign = "right";
                ctx.fillStyle = "#1a1a1a";
                
                const icon = getIconForType(item.rawCuisine, mode);
                ctx.font = "50px serif"; 
                ctx.fillText(icon, radius - 80, 15);

                ctx.font = "900 24px 'Nunito'";
                let text = item.name.length > 10 ? item.name.substring(0, 8) + ".." : item.name;
                ctx.fillText(text, radius - 20, 10);
                
                ctx.restore();
            });
        }

        function setupSpin(mode) {
            const btn = document.getElementById('spin-' + mode);
            
            btn.onclick = () => {
                let pool = [];
                restaurants.forEach(p => { pool.push(p); if(favs.includes(p.id)) pool.push(p); });
                
                if (pool.length === 0) return alert("No places found! Try a broader search.");

                currentWinner = pool[Math.floor(Math.random() * pool.length)];
                
                let wheelItems = [];
                let candidates = pool.filter(p => p.id !== currentWinner.id);
                candidates.sort(() => Math.random() - 0.5);
                wheelItems = candidates.slice(0, 7);
                wheelItems.push(currentWinner);
                wheelItems.sort(() => Math.random() - 0.5);
                
                const winnerIndex = wheelItems.findIndex(p => p.id === currentWinner.id);

                document.getElementById('roulette-' + mode + '-area').classList.remove('hidden');
                document.getElementById('result-' + mode).classList.add('hidden');
                btn.disabled = true;
                
                const sliceAngle = (2 * Math.PI) / wheelItems.length;
                const sliceCenter = winnerIndex * sliceAngle + (sliceAngle / 2);
                const spins = 5; 
                const targetRotation = (3 * Math.PI / 2) - sliceCenter + (spins * 2 * Math.PI);
                
                let startTime = null;
                const duration = 5000;
                const canvasId = 'wheel-canvas-' + mode;

                function animate(timestamp) {
                    if (!startTime) startTime = timestamp;
                    const elapsed = timestamp - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const ease = 1 - Math.pow(1 - progress, 5); 
                    const currentRotation = targetRotation * ease;
                    
                    // Pass MODE to drawWheel to enforce specific emojis
                    drawWheel(canvasId, wheelItems, currentRotation, mode);

                    if (progress < 1) requestAnimationFrame(animate);
                    else finishSpin();
                }

                function finishSpin() {
                    document.getElementById('name-' + mode).innerText = currentWinner.name;
                    document.getElementById('rating-' + mode).innerText = "‚≠ê".repeat(Math.floor(currentWinner.rating));
                    document.getElementById('details-' + mode).innerText = `${currentWinner.type} ‚Ä¢ ${currentWinner.dist} MILES`;
                    document.getElementById('maps-' + mode).href = `http://googleusercontent.com/maps.google.com/?q=${currentWinner.lat},${currentWinner.lon}`;
                    document.getElementById('menu-' + mode).href = `https://www.google.com/search?q=${encodeURIComponent(currentWinner.name + ' Menu')}`;
                    
                    document.getElementById('result-' + mode).classList.remove('hidden');
                    btn.innerText = "SPIN AGAIN";
                    btn.disabled = false;
                    saveToHist(currentWinner);
                }

                requestAnimationFrame(animate);
            };
            
            document.getElementById('share-' + mode).onclick = async () => {
                if(currentWinner && navigator.share) await navigator.share({ title: 'Jackpot Winner', text: `Let's go to: ${currentWinner.name}`, url: `http://googleusercontent.com/maps.google.com/?q=${currentWinner.lat},${currentWinner.lon}` });
            };
        }
        setupSpin('food');
        setupSpin('bar');
        setupSpin('coffee');

        function updateSplit() {
            const t = parseFloat(document.getElementById('bill-total').value)||0, tp = parseFloat(document.getElementById('tip-percent').value), n = parseInt(document.getElementById('people-count').value)||0;
            if(t>0&&n>0) document.getElementById('split-result').innerText = `TOTAL: $${(t*(1+tp)).toFixed(2)} | $${(t*(1+tp)/n).toFixed(2)} EACH`;
        }
        ['bill-total','tip-percent','people-count'].forEach(id=>document.getElementById(id).addEventListener('input',updateSplit));

        function saveToHist(p) { 
            history.unshift({ name: p.name, rating: p.rating, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) }); 
            if(history.length>20) history.pop(); 
            localStorage.setItem('jpot_hist', JSON.stringify(history)); 
        }

        function renderHistory() { 
            const list = document.getElementById('history-list');
            if(history.length === 0) { list.innerHTML = "<p class='text-center text-xs text-gray-400 font-bold'>No history yet!</p>"; return; }
            list.innerHTML = history.map(h => `
                <div class="p-3 bg-white border-2 border-black rounded-xl flex justify-between items-center shadow-[2px_2px_0_black]">
                    <div><h4 class="font-black text-[11px] truncate w-32">${h.name}</h4><p class="text-[9px] text-orange-500 font-bold">‚≠ê ${h.rating || '--'} ‚Ä¢ ${h.time}</p></div>
                    <a href="https://www.google.com/search?q=${encodeURIComponent(h.name + ' Menu')}" target="_blank" class="text-[9px] bg-yellow-200 border border-black px-2 py-1 rounded font-black hover:bg-yellow-300 uppercase">üìñ Menu</a>
                </div>`).join('');
        }

        function toggleFav(id) { 
            const i = favs.indexOf(id); if(i>-1) favs.splice(i,1); else favs.push(id); 
            localStorage.setItem('jpot_favs', JSON.stringify(favs)); 
            if(restaurants.length > 0) renderList(currentMode); 
        }
        
        function calcDist(la1,lo1,la2,lo2) { 
            const R=3958.8, dLa=(la2-la1)*Math.PI/180, dLo=(lo2-lo1)*Math.PI/180, a=Math.sin(dLa/2)**2+Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dLo/2)**2; 
            return (R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))).toFixed(1); 
        }
    </script>
</body>
</html>
