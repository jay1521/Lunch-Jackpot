<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lunch Jackpot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'casino-pink': '#ff00cc',
                        'casino-purple': '#333399',
                        'casino-blue': '#00ccff',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: linear-gradient(135deg, #ff00cc, #333399, #00ccff);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            -webkit-animation: gradientBG 15s ease infinite;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .roulette-window {
            height: 80px;
            overflow: hidden;
            position: relative;
            border-radius: 12px;
            background: #fff;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
            border: 4px solid #fbbf24;
        }

        .highlight-bar {
            position: absolute;
            top: 50%; left: 0; right: 0;
            height: 40px;
            margin-top: -20px;
            background: rgba(251, 191, 36, 0.1);
            border-top: 2px solid #fbbf24;
            border-bottom: 2px solid #fbbf24;
            pointer-events: none;
            z-index: 20;
        }

        .roulette-belt {
            display: flex;
            flex-direction: column;
            align-items: center;
            transform: translateY(0);
        }

        .roulette-item {
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.25rem;
            color: #333;
            text-align: center;
            padding: 0 10px;
            width: 100%;
        }

        .spinning {
            animation: slideUp 4s cubic-bezier(0.1, 1, 0.2, 1) forwards;
            -webkit-animation: slideUp 4s cubic-bezier(0.1, 1, 0.2, 1) forwards;
        }

        @keyframes slideUp {
            0% { transform: translateY(0); }
            100% { transform: translateY(var(--scroll-distance)); }
        }

        .pop-in { animation: pop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .loader {
            border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid white;
            border-radius: 50%; width: 18px; height: 18px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="font-sans min-h-screen p-4 flex flex-col items-center">

    <header class="w-full max-w-md my-6 text-center text-white">
        <h1 class="text-4xl font-black mb-2 drop-shadow-lg">üé∞ Lunch Jackpot</h1>
        <div id="status-container" class="flex justify-center items-center gap-2 bg-white/20 py-2 px-4 rounded-full inline-flex backdrop-blur-sm">
            <div id="loader" class="loader"></div>
            <p class="text-sm font-medium" id="location-status">Initializing GPS...</p>
        </div>
    </header>

    <main class="w-full max-w-md flex flex-col gap-6">
        <div class="glass-card p-6 rounded-2xl shadow-2xl text-center">
            
            <div id="roulette-area" class="mb-6 hidden">
                <div class="roulette-window">
                    <div class="highlight-bar"></div>
                    <div id="roulette-belt" class="roulette-belt"></div>
                </div>
            </div>

            <div id="final-result-card" class="hidden mb-6 p-6 bg-gradient-to-br from-yellow-50 to-white rounded-xl border-4 border-yellow-400 shadow-lg animate-pop-in">
                <p class="text-xs text-yellow-700 uppercase tracking-widest font-black mb-1">‚ú® Winner ‚ú®</p>
                <h2 id="winner-name" class="text-2xl font-black text-gray-900 leading-tight mb-2">--</h2>
                <p id="winner-details" class="text-gray-600 text-sm font-medium mb-4">--</p>
                <a id="maps-link" href="#" target="_blank" class="inline-block bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-3 px-6 rounded-full transition-all active:scale-95 shadow-lg">
                    üó∫Ô∏è Get Directions
                </a>
            </div>

            <button id="pick-btn" disabled class="w-full bg-gradient-to-r from-pink-600 to-purple-700 text-white font-black py-4 px-6 rounded-xl text-xl shadow-lg transition-all active:scale-95 disabled:opacity-50 disabled:grayscale">
                üé≤ SPIN TO WIN!
            </button>
            
            <button id="retry-location" class="mt-4 text-xs text-indigo-700 underline hidden">Retry Location Access</button>
        </div>

        <div class="glass-card p-5 rounded-2xl shadow-xl">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                <span class="mr-2">üìç</span> Nearby Contenders
            </h3>
            <div id="restaurant-list" class="flex flex-col gap-3 max-h-64 overflow-y-auto pr-1">
                <p class="text-sm text-gray-400 italic">Finding places nearby...</p>
            </div>
        </div>
    </main>

    <script>
        const listContainer = document.getElementById('restaurant-list');
        const locationStatus = document.getElementById('location-status');
        const loader = document.getElementById('loader');
        const pickBtn = document.getElementById('pick-btn');
        const retryBtn = document.getElementById('retry-location');
        const rouletteArea = document.getElementById('roulette-area');
        const rouletteBelt = document.getElementById('roulette-belt');
        const finalResultCard = document.getElementById('final-result-card');
        const winnerName = document.getElementById('winner-name');
        const winnerDetails = document.getElementById('winner-details');
        const mapsLink = document.getElementById('maps-link');

        let availableRestaurants = [];
        let userLat = 0, userLon = 0;

        // --- 1. GEOLOCATION (iOS Friendly) ---
        function getLocation() {
            loader.style.display = "block";
            retryBtn.classList.add('hidden');
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(fetchRestaurants, (err) => {
                    handleError("GPS Denied or Timeout");
                    retryBtn.classList.remove('hidden');
                }, { enableHighAccuracy: true, timeout: 8000 });
            } else {
                handleError("GPS not supported");
            }
        }

        window.addEventListener('load', getLocation);
        retryBtn.addEventListener('click', getLocation);

        // --- 2. DATA FETCH ---
        async function fetchRestaurants(position) {
            userLat = position.coords.latitude;
            userLon = position.coords.longitude;
            locationStatus.textContent = "Loading Restaurants...";
            
            const radius = 3000;
            const query = `[out:json];(node["amenity"~"restaurant|fast_food"](around:${radius},${userLat},${userLon}););out 20;`;

            try {
                const response = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
                const data = await response.json();

                availableRestaurants = data.elements
                    .filter(place => place.tags && place.tags.name)
                    .map(place => ({
                        name: place.tags.name,
                        type: place.tags.cuisine ? place.tags.cuisine.split(';')[0] : 'Restaurant',
                        distance: calculateDistance(userLat, userLon, place.lat, place.lon),
                        lat: place.lat,
                        lon: place.lon
                    }))
                    .filter((v,i,a)=>a.findIndex(t=>(t.name===v.name))===i)
                    .sort((a, b) => a.distance - b.distance);

                if (availableRestaurants.length > 0) {
                    renderList(availableRestaurants);
                    locationStatus.textContent = "Ready to Play!";
                    pickBtn.disabled = false;
                } else {
                    locationStatus.textContent = "No places found.";
                }
                loader.style.display = "none";
            } catch (err) { handleError("Network Error"); }
        }

        // --- 3. SPIN LOGIC ---
        pickBtn.addEventListener('click', () => {
            if (availableRestaurants.length === 0) return;
            
            finalResultCard.classList.add('hidden');
            rouletteArea.classList.remove('hidden');
            rouletteBelt.innerHTML = '';
            rouletteBelt.classList.remove('spinning');
            pickBtn.disabled = true;

            const winner = availableRestaurants[Math.floor(Math.random() * availableRestaurants.length)];
            
            // Build the belt
            let items = [];
            for(let i=0; i<6; i++) { // 6 rounds of the list
                availableRestaurants.forEach(p => items.push(`<div class="roulette-item">${p.name}</div>`));
            }
            items.push(`<div class="roulette-item text-pink-600 font-black">${winner.name}</div>`);
            rouletteBelt.innerHTML = items.join('');

            const scrollDistance = (items.length - 1) * 80;
            document.documentElement.style.setProperty('--scroll-distance', `-${scrollDistance}px`);

            setTimeout(() => {
                rouletteBelt.classList.add('spinning');
            }, 50);

            rouletteBelt.addEventListener('animationend', () => {
                setTimeout(() => showWinner(winner), 500);
            }, {once: true});
        });

        function showWinner(place) {
            rouletteArea.classList.add('hidden');
            winnerName.innerText = place.name;
            winnerDetails.innerText = `${place.type.toUpperCase()} ‚Ä¢ ${place.distance}km away`;
            
            // FIXED TEMPLATE LITERAL FOR IPHONE
            mapsLink.href = "https://www.google.com/maps/search/?api=1&query=" + place.lat + "," + place.lon;
            
            finalResultCard.classList.remove('hidden');
            finalResultCard.classList.add('pop-in');
            pickBtn.disabled = false;
        }

        // --- HELPERS ---
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2-lat1) * Math.PI / 180;
            const dLon = (lon2-lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return (R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)))).toFixed(1);
        }

        function handleError(msg) {
            loader.style.display = "none";
            locationStatus.textContent = msg;
            locationStatus.classList.add('text-red-200');
        }

        function renderList(data) {
            listContainer.innerHTML = data.map(p => `
                <div class="flex justify-between items-center p-3 bg-white/60 rounded-xl border border-white">
                    <div class="overflow-hidden"><h4 class="font-bold text-gray-800 truncate">${p.name}</h4><p class="text-[10px] text-gray-500 uppercase font-bold">${p.type}</p></div>
                    <span class="text-[10px] font-black bg-indigo-600 text-white px-2 py-1 rounded-full">${p.distance}km</span>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
